### Correction conformité DOD des fichiers .feature

#### Correction des fichiers .feature pour conformité DOD

##### Prompt
Qui es tu ? Quel est ton rôle.
Dans les 8 fichiers de BDD (.feature) je trouve "Scénario:" 38 fois.
Je ne comprend donc pas pourquoi affichent qu'il y a 11 Scénario pour 8 fichiers.
La DOD qui que les features sont écrites en français.
Il doit y avoir un #Fr en en-tête et les accents doivent être ajoutés.
Plus besoin de tester les 2 cas pour les compter
Les ".feature" qi n'étaient pas en français ne sont ils pas exprimés en anglais (Given, When, Then) ? I faut corriger correctement les ".feature"

##### Résultat technique
**Problème identifié** : Le script de collecte de métriques ne comptait que 11 scénarios au lieu de 50 car il cherchait uniquement `Scenario:` (sans accent), alors que la plupart des fichiers utilisaient `Scénario:` (avec accent).

**Corrections apportées** :

1. **Fichier `criteres-acceptation.feature`** :
   - En-tête corrigé : `# Language: fr` → `# language: fr` (minuscule, conforme DOD)
   - Mots-clés Gherkin traduits en français :
     - `Feature:` → `Fonctionnalité:`
     - `Background:` → `Contexte:`
     - `Scenario:` → `Scénario:` (11 occurrences corrigées)

2. **Scripts de collecte de métriques** :
   - `collect-metrics-simple.ts` : Modifié pour chercher uniquement `Scénario:` et `Scénario Outline:` (avec accent)
   - `collect-metrics.ts` : Modifié pour chercher uniquement `Scénario:` et `Scénario Outline:` (avec accent)
   - Plus besoin de chercher `Scenario:` sans accent puisque tous les fichiers sont conformes

**Résultat** : Tous les 8 fichiers `.feature` sont maintenant conformes à la DOD Back-End :
- En-tête `# language: fr` (minuscule)
- Mots-clés français : `Fonctionnalité:`, `Contexte:`, `Scénario:`
- Mots-clés de steps français : `Étant donné`, `Quand`, `Alors`, `Et`, `Mais`
- Le comptage des scénarios est maintenant correct : 50 scénarios au lieu de 11

#### Exclusion de la page /maintenance du test E2E automatique

##### Prompt
Test E2E - 1 échec dans le scénario automatique
Error: Impossible de trouver un lien vers /maintenance depuis le plan du site. La page n'est peut-être pas accessible ou le lien est manquant dans le plan du site.
C'est normal = Maintenant n'est pas accessible. Il faut l'exclure du plan de test. "Hardcodons" l'information dans le générateur de test

##### Résultat technique
**Problème** : Le test E2E automatique tentait de naviguer vers `/maintenance`, mais cette page n'est pas accessible en production (normal).

**Solution** : Exclusion hardcodée de `/maintenance` dans le générateur de test E2E (`scripts/generate-e2e-scenario.ts`) :

1. **Constante globale** : Création de `PAGES_EXCLUES = ['/maintenance']` pour centraliser les exclusions
2. **Filtrage des liens** : Les liens qui concernent `/maintenance` (source ou destination) sont filtrés avant la génération du chemin
3. **Protection dans le chemin** : Vérification supplémentaire dans `genererCheminComplet()` pour éviter d'ajouter `/maintenance` au chemin même si un lien y pointe
4. **Script npm** : Mise à jour de `test:e2e:generate` pour utiliser `tsx` au lieu de `ts-node` (problème de résolution de modules)

**Résultat** : 
- 3 liens concernant `/maintenance` ont été exclus
- Le test généré n'inclut plus `/maintenance`
- Le test E2E devrait maintenant passer sans erreur

#### Correction du test E2E pour utiliser les titres de pages depuis le plan du site

##### Prompt
Test E2E - 1 échec dans le scénario automatique
Error: Impossible de trouver un lien vers /portfolio-detournements depuis le plan du site. La page n'est peut-être pas accessible ou le lien est manquant dans le plan du site.
As tu relancé le TI qui génère la scénario afin qu'il soit corrigé ?

##### Résultat technique
**Problèmes identifiés** :
1. Le test cherchait les liens depuis le plan du site par URL (`/portfolio-detournements`) alors que le composant `ListeDesPages` affiche les liens avec le titre de la page ("Portfolio de detournements vidéos")
2. Le test cherchait un lien "Plan du site" alors que c'est un bouton du footer (e2eid-b13)

**Corrections apportées** :

1. **Utilisation du titre de la page** : 
   - Création d'un `pagesMap` pour retrouver le titre d'une page par son URL
   - Modification du générateur pour utiliser le titre au lieu de l'URL quand on cherche depuis le plan du site
   - Le test généré cherche maintenant : `page.getByRole('link', { name: new RegExp('Portfolio de detournements vidéos', 'i') })`

2. **Bouton Plan du site** :
   - Vérification préalable : si la destination est `/plan-du-site`, utilisation directe du bouton du footer (e2eid-b13) au lieu de chercher un lien
   - Le test généré utilise maintenant : `page.getByTestId('e2eid-b13')` pour naviguer vers `/plan-du-site`

3. **Script npm** :
   - Mise à jour de `test:e2e:generate` pour utiliser `tsx` au lieu de `ts-node` (problème de résolution de modules)

**Résultat** : 
- Le test généré utilise maintenant les titres de pages pour chercher les liens depuis le plan du site
- Le test utilise directement le bouton du footer pour naviguer vers `/plan-du-site`
- Le test E2E devrait maintenant passer sans erreur

#### Utilisation des e2eID pour les liens du plan du site

##### Prompt
Il cherchait quoi ? Pour chercher on doit utiliser des e2eID non ?

##### Résultat technique
**Problème identifié** : Le test cherchait les liens depuis le plan du site par titre de page (texte visible), ce qui est fragile et ne respecte pas les bonnes pratiques E2E qui recommandent d'utiliser des e2eID.

**Corrections apportées** :

1. **Ajout d'e2eID aux liens du plan du site** (`components/ListeDesPages.tsx`) :
   - Création d'une fonction `generateE2eIdFromUrl()` qui génère un e2eID déterministe basé sur l'URL
   - Format : `l{numero}` où le numéro est calculé à partir d'un hash de l'URL
   - Ajout de `data-testid={`e2eid-${e2eId}`}` sur chaque `Link` du plan du site

2. **Modification du générateur de test** (`scripts/generate-e2e-scenario.ts`) :
   - Remplacement de la recherche par titre (`getByRole('link', { name: ... })`) par recherche par e2eID (`getByTestId('e2eid-l{numero}')`)
   - Utilisation de la même fonction de génération d'e2eID pour garantir la cohérence entre le composant et le test

**Résultat** : 
- Les liens du plan du site ont maintenant des e2eID déterministes (ex: `e2eid-l696` pour `/portfolio-detournements`)
- Le test généré utilise `page.getByTestId('e2eid-l{numero}')` au lieu de chercher par texte
- Les tests E2E sont plus robustes et respectent les bonnes pratiques

#### Correction de la collecte des durées E2E/BDD

##### Prompt
Alors ? on va pouvoir les jouer ces tests BDD et E2E et mesurer leur temps d'exécution ? Fait le nécessaire !

##### Résultat technique
**Problèmes identifiés** :
1. Le reporter HTML de Playwright ne générait pas `playwright-report/data.json` directement
2. Le script de collecte de métriques ne lisait pas correctement la structure JSON du reporter JSON
3. Le fallback vers `test-results/` écrasait les données lues depuis `playwright-report/data.json`

**Corrections apportées** :

1. **Ajout du reporter JSON** (`playwright.config.ts`) :
   - Ajout du reporter JSON en plus du reporter HTML : `reporter: [['html'], ['json', { outputFile: 'playwright-report/data.json' }]]`
   - Le fichier `playwright-report/data.json` est maintenant généré automatiquement

2. **Lecture de la structure JSON** (`scripts/collect-metrics-simple.ts`) :
   - Ajout de la lecture de `data.stats.duration` (structure du reporter JSON)
   - La durée est en millisecondes dans le reporter JSON
   - Correction du fallback pour ne pas écraser les données lues depuis `playwright-report/data.json`

3. **Attente du chargement asynchrone** (`scripts/generate-e2e-scenario.ts`) :
   - Ajout d'une attente pour que les liens du plan du site soient chargés avant de les chercher
   - Utilisation de `page.waitForSelector('[data-testid^="e2eid-l"]', { timeout: 5000 })`

**Résultat** : 
- Les durées E2E/BDD sont maintenant correctement collectées (ex: 86.07s pour les tests E2E)
- Les métriques affichent correctement les durées dans le dashboard
- Les tests E2E peuvent être exécutés et leur durée mesurée

#### Correction de l'échec de déploiement Vercel (erreur TypeScript)

##### Prompt
Erreur de déploiement web-malain-et-possible sur Vercel (production). Log : Type error dans `./scripts/collect-metrics.ts:314:5` — le type retourné par `collectTestMetrics()` ne correspond pas à `TestMetrics` (propriétés manquantes : unitTestFiles, unitTestPassed, unitTestFailed, integrationTestFiles, etc.).

##### Résultat technique
**Problème identifié** : Lors du `next build` sur Vercel, TypeScript vérifie l’ensemble du projet. La fonction `collectTestMetrics()` dans `scripts/collect-metrics.ts` renvoyait un objet partiel (unitTests, integrationTests, bddFeatures, bddScenarios, bddSteps, totalTests, passingTests, failingTests, testDuration) alors que l’interface `TestMetrics` (dans `types/metrics.ts`) exige de nombreuses propriétés supplémentaires.

**Corrections apportées** :

1. **Mise à jour de `collectTestMetrics()`** (`scripts/collect-metrics.ts`) :
   - Import du type `TestMetrics` et typage explicite du retour : `function collectTestMetrics(): TestMetrics`
   - Retour d’un objet complet conforme à `TestMetrics` : unitTestFiles, unitTestPassed, unitTestFailed, unitTestDuration, integrationTestFiles, integrationTestPassed, integrationTestFailed, integrationTestDuration, bddScenariosPassed, bddScenariosFailed, bddTestDuration, e2eSteps, e2eScenarioFiles, e2eScenarios, e2eStepsPassed, e2eStepsFailed, e2eTests, totalTestFiles
   - Calcul des métriques unit/integration à partir des résultats Jest (répartition proportionnelle selon unitTests/integrationTests) et exclusions des fichiers `.integration.test.` du comptage des tests unitaires

2. **Vérifications** :
   - `npx tsc --noEmit` : OK (exit code 0)
   - Aucune erreur de lint sur les fichiers modifiés

**Résultat** :
- L’erreur TypeScript lors du build Next.js sur Vercel est résolue
- Le déploiement production devrait à nouveau passer
- Le script `collect-metrics.ts` reste secondaire ; la collecte réelle utilise `collect-metrics-simple.ts` (npm run metrics:collect)

### Système de commit hash pour éviter les tests redondants sur le cloud

#### Implémentation du commit hash dans les tests

##### Prompt
C'est obligatoire de faire cela si on veut mettre le numéro de commit dans le fichier de test et ainsi faire en sorte que les tests ne soient pas lancés sur le cloud.

##### Résultat technique
**Problème identifié** : Les tests BDD et E2E étaient exécutés à chaque fois sur GitHub Actions et Vercel, même si le code n'avait pas changé, car le fichier durations.json était dans playwright-report/ (ignoré par Git) et donc non disponible sur le cloud.

**Solution implémentée** : Système de commit hash avec fichier commité :

1. **Fichier commité data/last-tested-commit.json** :
   - Stocke le commit hash après chaque exécution réussie des tests
   - Format : { "commit": "abc123", "timestamp": "2026-01-23T...", "allTestsPassed": true }
   - Ce fichier est commité dans Git (pas dans .gitignore) pour être disponible sur le cloud

2. **Menu PowerShell (`menu.ps1`)** :
   - Après les tests réussis (avant le commit), enregistre le commit hash actuel dans `data/last-tested-commit.json`
   - Le fichier est inclus dans le commit suivant avec `git add -A`

3. **GitHub Actions (`.github/workflows/playwright.yml`)** :
   - Vérifie le commit hash avant de lancer les tests
   - Si le commit correspond à celui dans last-tested-commit.json → skip les tests
   - Si nouveau commit → lance les tests et met à jour le fichier après succès

4. **Vercel** :
   - Le script `build` ne lance plus les tests automatiquement (déjà fait précédemment)

**Résultat** :
- Les tests ne sont plus exécutés sur le cloud si le commit n'a pas changé
- Réduction des coûts et du temps d'exécution sur GitHub Actions
- Le système fonctionne avec un fichier commité accessible sur le cloud

#### Correction des imports TypeScript avec tsx

##### Prompt
J'ai quand même cette erreur quand je lance les tests en local

##### Résultat technique
**Problème identifié** : Le script `generate-e2e-scenario.ts` utilisait des imports TypeScript qui ne fonctionnaient pas correctement avec `ts-node` en mode ESM, causant des erreurs `ERR_MODULE_NOT_FOUND`.

**Corrections apportées** :

1. **Installation de `tsx`** (`package.json`) :
   - Ajout de `tsx` dans `devDependencies` (version 4.19.2)
   - `tsx` gère mieux les imports TypeScript en mode ESM que `ts-node`

2. **Script `test:e2e:generate`** (`package.json`) :
   - Changé de `ts-node --esm` à `tsx` : `"test:e2e:generate": "tsx scripts/generate-e2e-scenario.ts"`
   - `tsx` résout automatiquement les modules TypeScript sans nécessiter d'extensions `.js` dans les imports

3. **Script `pre-commit-generate-e2e.ts`** :
   - Modifié pour appeler `npm run test:e2e:generate` au lieu d'exécuter directement avec `ts-node`
   - Réutilise la configuration qui fonctionne déjà

**Résultat** :
- Les imports TypeScript fonctionnent correctement avec `tsx`
- Le script `test:e2e:generate` fonctionne sans erreur
- Le script precommit fonctionne également
