# Problèmes Rencontrés et Résolus

*Catalogue des problèmes majeurs rencontrés et leurs solutions, pour éviter de les reproduire.*

---

## 1. La Bataille des Tooltips (24 janvier 2026)

### Symptôme
Les info-bulles de la page Metrics apparaissaient **sous** d'autres éléments au lieu de flotter au-dessus.

### Cause Racine
Les tooltips étaient rendues **DANS** la carte parent, héritant de son contexte d'empilement (stacking context). Un `z-index` même très élevé ne peut pas sortir de ce contexte.

### Solution
**React Portal vers `document.body`** :
```typescript
import { createPortal } from 'react-dom';
// ...
return createPortal(
  <div className="tooltip" style={{ position: 'fixed', zIndex: 999999 }}>
    {content}
  </div>,
  document.body
);
```

### Leçon Apprise
- Une tooltip doit **toujours** utiliser un Portal
- Le mot "dessous" est ambigu (position Y vs z-index) — toujours préciser

---

## 2. Confusion "dessous" Vertical vs Z-index

### Symptôme
Multiples corrections inefficaces car l'IA confondait :
- Position verticale (Y, "bottom") 
- Z-index (couches d'empilement)

### Cause
Le terme "dessous" a deux sens en CSS/UI.

### Solution
Être explicite dans les prompts :
- ❌ "L'info bulle est sous les icônes"
- ✅ "L'info bulle est sous les icônes EN TERMES DE Z-INDEX (couches)"

### Leçon Apprise
Toujours préciser le concept technique quand un mot a plusieurs sens.

---

## 3. Tests Désynchronisés après Refactoring

### Symptômes
- Tests qui attendent `h1` alors que le composant utilise `h2`
- Chemins d'import obsolètes (`../../app/maintenance/page` vs `../../app/(main)/maintenance/page`)
- Props testées qui n'existent plus

### Cause
Les tests n'avaient pas été mis à jour lors des refactorings précédents.

### Solutions
1. **Chemins** : Mettre à jour les imports après déplacement de fichiers
2. **Assertions** : Vérifier ce que le composant rend réellement, pas ce qu'il rendait avant
3. **Props** : Supprimer les tests de props obsolètes

### Leçon Apprise
Après un refactoring structurel, toujours lancer la suite de tests complète.

---

## 4. E2eID Conflictuels

### Symptôme
Le test E2E échouait car un e2eID généré par le système déterministe (plan du site) était identique à un e2eID du système séquentiel.

### Cause
Les deux systèmes utilisaient la même plage de numéros (0-999).

### Solution
**2 plages réservées** pour le système déterministe :
- `l600-l749` (150 numéros)
- `l800-l949` (150 numéros)

Le système séquentiel saute automatiquement ces plages.

### Leçon Apprise
Quand deux systèmes génèrent des identifiants, définir des plages disjointes.

---

## 5. Métriques Hardcodées Affichées comme Valeurs Réelles

### Symptôme
"Complexité Cyclomatique : 5" affichée alors que la valeur n'est pas calculée.

### Cause
Valeurs fictives hardcodées dans le code pour faire joli pendant le développement.

### Solution
Remplacer par `"NC"` (Non Calculé) et masquer les cartes dont la valeur est `"NC"`.

### Leçon Apprise
Jamais de valeurs fictives en dur — utiliser un placeholder explicite ("NC", "N/A").

---

## 6. Chronométrage BDD/E2E Mélangé

### Symptômes
- v1 : Durées BDD et E2E identiques (une seule mesure)
- v2 : Durée BDD à zéro

### Cause
Le fichier `data.json` de Playwright contenait les résultats combinés. La durée était lue depuis ce fichier au lieu d'être mesurée indépendamment.

### Solution
**Mesure séparée avec `Date.now()`** :
```typescript
const startBdd = Date.now();
await runBddTests();
const bddDuration = Date.now() - startBdd;

const startE2e = Date.now();
await runE2eTests();
const e2eDuration = Date.now() - startE2e;
```

Stockage dans `durations.json`, pas dans `data.json`.

### Leçon Apprise
Toujours mesurer les durées explicitement, ne pas les déduire de fichiers intermédiaires.

---

## 7. Plan du Site Vide sur Vercel

### Symptôme
La page plan-du-site affichait un contenu vide sur Vercel mais fonctionnait en local.

### Causes
1. Le fichier `_Pages-Et-Lien.json` n'était pas régénéré avant le build
2. Les pages n'avaient pas de propriété `zone` (filtrage échouait)

### Solutions
1. Génération automatique du plan du site dans le script de build
2. Assignation automatique des zones selon l'URL dans `detecterPages()`

### Leçon Apprise
Tout fichier généré doit être régénéré automatiquement lors du build.

---

## 8. Marge Droite Résiduelle dans Tooltip

### Symptôme
Espace à droite dans la tooltip même après suppression de l'ascenseur.

### Cause
Règles CSS résiduelles de l'ascenseur (`overflow-y: auto`, `max-height`).

### Solution
Supprimer complètement les styles d'ascenseur :
```css
overflow-y: visible;
max-height: none;
```

### Leçon Apprise
Quand on supprime une fonctionnalité CSS, supprimer TOUTES les règles associées.

---

## 9. path Traversal dans les Lecteurs de Fichiers

### Symptôme
Vulnérabilité de sécurité permettant d'accéder à des fichiers hors du répertoire autorisé.

### Cause
Concaténation directe du chemin utilisateur sans validation :
```typescript
// ❌ Vulnérable
const filePath = path.join(process.cwd(), userPath);
```

### Solution
Validation avec `path.resolve()` :
```typescript
function validateAndResolvePath(relativePath: string, allowedBase: string): string {
  const resolvedPath = path.resolve(process.cwd(), relativePath);
  const allowedDir = path.resolve(process.cwd(), allowedBase);
  if (!resolvedPath.startsWith(allowedDir + path.sep)) {
    throw new Error(`Accès interdit: chemin hors répertoire autorisé`);
  }
  return resolvedPath;
}
```

### Leçon Apprise
Toujours valider les chemins avant d'accéder aux fichiers.

---

## 10. Titres Redondants dans Tooltips

### Symptôme
Le titre de la métrique apparaissait deux fois : dans le bloc bleu ET dans la tooltip.

### Cause
Le composant `MetricTooltip` incluait un `<h4>` avec le titre.

### Solution
Supprimer le titre de la tooltip — il est déjà visible juste en dessous sur le bloc bleu.

### Leçon Apprise
Éviter la redondance d'information dans l'UI.

---

## 11. Auteurs de Citations Non Affichés

### Symptôme
Les citations dans les compétences n'affichaient plus l'auteur.

### Causes
1. Le champ `auteur` n'était pas défini dans l'interface TypeScript
2. Le champ n'était pas copié lors de la résolution des références (bibliothèque)
3. La classe CSS utilisait `styles.competenceAuteur` au lieu de la classe globale

### Solutions
1. Ajouter `auteur?: string` à l'interface `Competence`
2. Copier `auteur: competence.auteur` dans `profilBuilder.ts`
3. Utiliser la classe globale `competenceAuteur`

### Leçon Apprise
Vérifier les 3 couches : interface TypeScript, logique de résolution, CSS.

---

## 12. Imports CSS Modules Vides

### Symptôme
Erreur "Failed to fetch" après refactorisation CSS.

### Cause
Composants important des CSS modules vides (contenant seulement un commentaire de déplacement) sans les utiliser.

### Solution
Supprimer tous les imports CSS modules non utilisés.

### Leçon Apprise
Après migration CSS, supprimer les imports obsolètes, pas seulement vider les fichiers.

---

## 13. Algorithme E2E Visitant 63 Pages au lieu de 13

### Symptôme
Le scénario E2E visitait 63 pages alors que le site n'en a que 13.

### Cause
L'algorithme glouton repassait plusieurs fois par les mêmes pages pour suivre différents liens.

### Solution
Refactorisation : visiter chaque page **une seule fois**, marquer tous ses liens comme testés.

### Leçon Apprise
Un algorithme glouton naïf peut être très inefficace — optimiser dès que le résultat est anormal.

---

## 14. Commande Jest Incorrecte

### Symptôme
Tests Jest ne s'exécutent pas correctement.

### Cause
Utilisation de `--testPathPattern` au lieu de `--testPathPatterns` (avec 's').

### Solution
```bash
npm test -- --testPathPatterns="tests/unit"
```

### Leçon Apprise
Vérifier la documentation pour les options CLI exactes.

---

## 15. Agents Manquants sur Vercel

### Symptôme
Le board KanBan n'affichait que 2 colonnes (A faire, Fait) sur Vercel.

### Cause
Le dossier `.cursor/agents` n'était pas poussé sur GitHub (`.gitignore`).

### Solution
Créer `data/A propos/agents.json` comme source de vérité, synchronisé depuis `.cursor/agents` en dev.

### Leçon Apprise
Pour les données utilisées en production, avoir une source dans `data/` (pas dans `.cursor/`).

---

*Ce catalogue sera enrichi au fil des problèmes rencontrés.*
