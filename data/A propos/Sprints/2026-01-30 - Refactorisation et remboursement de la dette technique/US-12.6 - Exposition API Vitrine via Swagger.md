# US-12.6 - Exposition API Vitrine via Swagger

## En tant que
Consommateur technique du site (robot, développeur)

## Je souhaite
Disposer d'une API REST documentée (Swagger/OpenAPI) pour accéder aux données du site vitrine

## Afin de
- Consommer les données du site de manière programmatique
- Avoir une documentation interactive des endpoints
- Illustrer les bonnes pratiques d'architecture API

## Critères d'acceptation

### Paramètre `?mode=` obligatoire

Deux paradigmes de réponse :

| Mode | Paradigme | Comportement |
|------|-----------|--------------|
| `full` | **Objet** (ORM) | Arbre complet embarqué, tout résolu jusqu'aux feuilles |
| `refs` | **Relationnel** (SQL) | Seulement les clés étrangères (slugs) du niveau courant |

**Erreur si mode manquant** :
```json
{
  "error": "Missing required parameter: mode",
  "hint": "Use ?mode=refs or ?mode=full"
}
```

### Endpoints avec mode obligatoire

| Endpoint | `mode=refs` | `mode=full` |
|----------|-------------|-------------|
| `/api/vitrine/pages` | Liste `{slug, type}` | Contenu complet de chaque page |
| `/api/vitrine/pages/{slug}` | Page avec FK non résolues | Page complète (arbre) |
| `/api/vitrine/profils` | Profils avec `domaines: [slug, ...]` | Arbre profil→domaines→compétences→expériences |
| `/api/vitrine/profils/{slug}` | Profil avec FK domaines | Arbre complet |
| `/api/vitrine/domaines` | Domaines avec `competences: [slug, ...]` | Arbre domaine→compétences→expériences |
| `/api/vitrine/domaines/{slug}` | Domaine avec FK compétences | Arbre complet |
| `/api/vitrine/competences` | Compétences avec `experiences: [id, ...]` | Arbre compétence→expériences |
| `/api/vitrine/competences/{slug}` | Compétence avec FK expériences | Arbre complet |

### Endpoints feuilles (sans mode)

Pas de sous-niveau, mode ignoré/optionnel :

```
GET /api/vitrine/experiences           → toutes les expériences (triées par date)
GET /api/vitrine/experiences/{id}      → une expérience
GET /api/vitrine/detournements         → tous les détournements vidéo
GET /api/vitrine/detournements/{slug}  → un détournement
GET /api/vitrine/temoignages           → tous les témoignages
GET /api/vitrine/version               → version du site
```

### Exemples de réponses

**Mode `refs`** (relationnel) :
```json
// GET /api/vitrine/profils/agile?mode=refs
{
  "slug": "agile",
  "titre": "Transformation Agile",
  "jobTitles": ["Coach Agile", "Scrum Master"],
  "cvPath": "/CV/agile.pdf",
  "domaines": ["strategie-et-transformations", "faire-avec-les-equipes"]
}
```

**Mode `full`** (objet) :
```json
// GET /api/vitrine/profils/agile?mode=full
{
  "slug": "agile",
  "titre": "Transformation Agile",
  "jobTitles": ["Coach Agile", "Scrum Master"],
  "cvPath": "/CV/agile.pdf",
  "domaines": [{
    "slug": "strategie-et-transformations",
    "titre": "Stratégie et transformations",
    "contenu": "...",
    "competences": [{
      "slug": "conduite-du-changement",
      "titre": "Conduite du changement",
      "description": "...",
      "experiences": [{
        "id": "11",
        "categorie": "Formation",
        "description": "...",
        "periode": "2020-2021"
      }]
    }]
  }]
}
```

### CA7 - Compatibilité contrat Node.js / REST

Le JSON retourné par l'API REST en mode `full` doit être **strictement identique** au JSON retourné par l'appel Node.js direct.

| Appel Node.js | Appel REST | Assertion |
|---------------|------------|-----------|
| `readPageData('index.json')` | `GET /api/vitrine/pages/index?mode=full` | JSON identique |
| `readPageData('mes-profils.json')` | `GET /api/vitrine/pages/mes-profils?mode=full` | JSON identique |
| `readPageData('profil-agile.json')` | `GET /api/vitrine/profils/agile?mode=full` | JSON identique |

Cela garantit que le site vitrine peut migrer vers l'API REST sans régression.

### Documentation Swagger

- [ ] Spec OpenAPI générée automatiquement
- [ ] Interface Swagger UI accessible dans "À propos du site"
- [ ] Modèles de données documentés
- [ ] Exemples de réponses pour chaque mode

### Modèles de données

```typescript
// Mode refs : FK = string[]
// Mode full : FK = Object[]

interface ProfilAPI {
  slug: string;
  titre: string;
  jobTitles: string[];
  cvPath: string;
  domaines: DomaineAPI[] | string[];  // full ou refs
}

interface DomaineAPI {
  slug: string;
  titre: string;
  contenu: string;
  auteur?: string;
  competences: CompetenceAPI[] | string[];  // full ou refs
}

interface CompetenceAPI {
  slug: string;
  titre: string;
  description: string;
  icon?: string;
  image?: { src: string; alt: string };
  experiences: ExperienceAPI[] | string[];  // full ou refs
}

interface ExperienceAPI {
  id: string;
  categorie: string;
  description: string;
  periode: string | null;
}

interface DetournementAPI {
  slug: string;
  titre: string;
  description: string;
  videoUrl: string;
  thumbnail?: string;
}

interface TemoignageAPI {
  auteur: string;
  role: string;
  contenu: string;
  date?: string;
}
```

## Notes techniques

- Utiliser `next-swagger-doc` ou équivalent pour Next.js
- Les endpoints appellent les fonctions de `utils/vitrine/`
- Seul le domaine Vitrine est exposé en Swagger
- Projet et BackOffice restent en Node.js (import direct)
- Le site vitrine lui-même utilisera `?mode=full` pour recevoir des JSON prêts à l'emploi