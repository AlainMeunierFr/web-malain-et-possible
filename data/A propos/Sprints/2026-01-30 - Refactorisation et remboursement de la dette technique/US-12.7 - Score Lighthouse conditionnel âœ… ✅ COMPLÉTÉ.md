# US-12.7 : Score Lighthouse conditionnel

## En tant que développeur / mainteneur du projet

## Je souhaite avoir les scores Lighthouse intégrés aux métriques automatiques, avec une exécution conditionnelle uniquement si le dernier rapport date de plus de 7 jours

## Afin de :

- Suivre la performance, l'accessibilité, les bonnes pratiques et le SEO du site de manière automatisée
- Ne pas ralentir l'exécution quotidienne de `npm run metrics:collect`
- Garder des métriques fraîches sans surcoût opérationnel ni consommation excessive de ressources

# Critères d'acceptation

## CA1 - CA1 - Stockage du timestamp de la dernière exécution
- Le fichier `history.json` contient un champ `lastLighthouseRun` (format ISO 8601, ex. `"2026-01-30T14:30:00.000Z"`)
- Ce champ est mis à jour à chaque exécution réussie de Lighthouse
- Si le champ n'existe pas, Lighthouse s'exécute (première exécution)

## CA2 - CA2 - Condition d'exécution (7 jours minimum)
- Lighthouse ne s'exécute que si la date actuelle dépasse `lastLighthouseRun` de plus de 7 jours
- Si le délai n'est pas atteint, les scores existants sont conservés sans nouvelle exécution
- Un message de log indique « Lighthouse skipped: last run X days ago » ou « Lighthouse running: last run X days ago »

## CA3 - CA3 - Scores collectés
- Quatre scores sont collectés : Performance, Accessibilité, Bonnes pratiques, SEO
- Chaque score est un entier de 0 à 100
- Les scores sont stockés dans un objet `lighthouse` du fichier de métriques (ex. `{ "performance": 92, "accessibility": 100, "bestPractices": 95, "seo": 98 }`)

## CA4 - CA4 - Page cible et méthode
- L'analyse utilise l'API PageSpeed Insights de Google (gratuite, pas de Chrome local requis)
- L'URL cible est l'URL de **production** (Vercel) : `https://m-alain-et-possible.fr`
- L'URL est configurable via une constante dans le code (`PROD_URL` dans `lighthouseCollector.ts`)
- Note : légère incohérence possible entre les métriques locales et le site prod, acceptable car publication régulière

## CA5 - CA5 - Affichage dans MetricsCompact
- Les 4 scores apparaissent dans la section « Autres indicateurs » du composant `MetricsCompact`
- Chaque score est affiché avec son libellé (Performance, Accessibilité, Bonnes pratiques, SEO)
- Un code couleur indique le niveau : vert (≥90), orange (50-89), rouge (<50)

## CA6 - CA6 - Fallback en cas d'échec
- Si Lighthouse n'est pas disponible (Chrome absent) ou échoue, les scores affichent « NC » (Non Calculé)
- Aucune erreur bloquante n'est levée ; le script `metrics:collect` continue normalement
- Un message de warning est logué pour indiquer la raison de l'échec

## CA7 - CA7 - Compatibilité environnements
- Le script fonctionne sur poste de dev et en CI sans dépendance Chrome
- L'API PageSpeed Insights est une API HTTP, donc universellement compatible

**Notes techniques** :
- Utiliser l'API PageSpeed Insights de Google (gratuite, ~400 requêtes/jour sans clé)
- Endpoint : `https://www.googleapis.com/pagespeedonline/v5/runPagespeed`
- Clé API optionnelle via `PAGESPEED_API_KEY` dans `.env.local` (recommandé pour éviter les erreurs 429)
- La date `lastLighthouseRun` n'est sauvegardée que si le test réussit (au moins un score valide)
- Pas de dépendance npm additionnelle (fetch natif, dotenv pour .env.local)